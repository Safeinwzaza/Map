<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>LIFF Live Navigation</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: system-ui, -apple-system, sans-serif;
}
#map { height: 100%; }

/* ===== Top Nav Card ===== */
#navCard {
  position: absolute;
  top: 14px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  border-radius: 18px;
  padding: 14px 20px;
  min-width: 260px;
  z-index: 1200;
  box-shadow: 0 4px 12px rgba(0,0,0,.35);
  text-align: center;
}
#navMain {
  font-size: 17px;
  font-weight: 600;
}
#navSub {
  font-size: 14px;
  opacity: .7;
}

/* ===== Floating Buttons ===== */
.map-btn {
  position: absolute;
  right: 14px;
  z-index: 1200;
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: none;
  background: white;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 3px 10px rgba(0,0,0,.3);
}
#focusUserBtn { bottom: 200px; }
#focusBBtn    { bottom: 140px; }
#routeBtn     { bottom: 80px; background:#1e88ff; color:white; }

/* ===== Bottom Sheet ===== */
#bottomPanel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -220px;
  background: white;
  border-radius: 22px 22px 0 0;
  padding: 18px 22px 26px;
  box-shadow: 0 -4px 12px rgba(0,0,0,.35);
  z-index: 1200;
  transition: bottom .3s ease;
}
#bottomPanel.show { bottom: 0; }

#bottomPanel h3 {
  margin: 0 0 10px;
  font-size: 18px;
}
.bottom-item {
  font-size: 16px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<div id="navCard">
  <div id="navMain">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‚Ä¶</div>
  <div id="navSub">-</div>
</div>

<button id="focusUserBtn" class="map-btn">üìç</button>
<button id="focusBBtn" class="map-btn">üìå</button>
<button id="routeBtn" class="map-btn">üß≠</button>

<div id="bottomPanel">
  <h3>üß≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</h3>
  <div class="bottom-item" id="distance">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: -</div>
  <div class="bottom-item" id="time">‡πÄ‡∏ß‡∏•‡∏≤: -</div>
  <div class="bottom-item" id="place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: -</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
/* ===== MAP ===== */
const map = L.map('map', { zoomControl: true, maxZoom: 21 })
  .setView([16.7469, 100.1969], 17);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 21
}).addTo(map);

map.attributionControl.setPrefix(false);

/* ===== STATE ===== */
let routingControl = null;
let isRouting = false;
let autoFollow = true;

/* ===== ICON B ===== */
const bIcon = L.icon({
  iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red.png',
  iconSize: [32,32],
  iconAnchor: [16,32]
});

/* ===== MARKER B ===== */
let bLat = 16.7479, bLng = 100.1947;
const bMarker = L.marker([bLat,bLng], { icon: bIcon }).addTo(map);

/* ===== USER ICON ===== */
function userIcon(heading=0){
  return L.divIcon({
    html: `
      <div style="transform:rotate(${heading}deg);transition:.2s">
        <svg width="36" height="36" viewBox="0 0 100 100">
          <circle cx="50" cy="50" r="22" fill="#1e88ff" stroke="white" stroke-width="6"/>
          <polygon points="50,5 40,30 60,30" fill="#1e88ff"/>
        </svg>
      </div>`,
    iconSize:[36,36],
    iconAnchor:[18,18]
  });
}

let userLat, userLng, userMarker;
let lastLat=null, lastLng=null, heading=0;

/* ===== GEOLOCATION ===== */
navigator.geolocation.watchPosition(pos=>{
  userLat = pos.coords.latitude;
  userLng = pos.coords.longitude;

  if(lastLat){
    heading = calcHeading(lastLat,lastLng,userLat,userLng);
  }

  if(!userMarker){
    userMarker = L.marker([userLat,userLng],{icon:userIcon(heading)}).addTo(map);
    map.setView([userLat,userLng],18);
  }else{
    userMarker.setLatLng([userLat,userLng])
      .setIcon(userIcon(heading));
  }

  lastLat=userLat; lastLng=userLng;

  if(isRouting && autoFollow){
    map.panTo([userLat,userLng],{animate:true,duration:.7});
  }
},null,{enableHighAccuracy:true});

/* ===== ROUTING ===== */
function startRouting(){
  if(!userLat) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");

  if(routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    waypoints:[
      L.latLng(userLat,userLng),
      L.latLng(bLat,bLng)
    ],
    addWaypoints:false,
    draggableWaypoints:false,
    createMarker:()=>null,
    show:false,
    lineOptions:{
      styles:[
        {color:'#fff',weight:10,opacity:.9},
        {color:'#1e88ff',weight:6,opacity:1}
      ]
    }
  }).addTo(map);

  routingControl.on('routesfound',e=>{
    const r=e.routes[0];
    navMain.innerText=`‚è± ${(r.summary.totalTime/60).toFixed(0)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    navSub.innerText=`üìè ${(r.summary.totalDistance/1000).toFixed(2)} ‡∏Å‡∏°.`;

    distance.innerText=`‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${(r.summary.totalDistance/1000).toFixed(2)} ‡∏Å‡∏°.`;
    time.innerText=`‡πÄ‡∏ß‡∏•‡∏≤: ${(r.summary.totalTime/60).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;

    bottomPanel.classList.add('show');
  });

  isRouting=true;
  autoFollow=true;
}

function stopRouting(){
  if(routingControl) map.removeControl(routingControl);
  routingControl=null;
  bottomPanel.classList.remove('show');
  navMain.innerText="‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡∏ó‡∏≤‡∏á";
  navSub.innerText="-";
  isRouting=false;
}

/* ===== UPDATE ROUTE ===== */
setInterval(()=>{
  bLat+=(Math.random()-.5)*0.00025;
  bLng+=(Math.random()-.5)*0.00025;
  bMarker.setLatLng([bLat,bLng]);
  if(routingControl){
    routingControl.setWaypoints([
      L.latLng(userLat,userLng),
      L.latLng(bLat,bLng)
    ]);
  }
},5000);

/* ===== BUTTONS ===== */
routeBtn.onclick=()=>{
  if(!isRouting){
    startRouting();
    routeBtn.innerText='‚ùå';
  }else{
    stopRouting();
    routeBtn.innerText='üß≠';
  }
};
focusUserBtn.onclick=()=>userLat&&map.setView([userLat,userLng],18);
focusBBtn.onclick=()=>map.setView([bLat,bLng],18);

map.on('dragstart zoomstart',()=>autoFollow=false);

/* ===== HEADING ===== */
function calcHeading(lat1,lng1,lat2,lng2){
  const toRad=d=>d*Math.PI/180;
  const y=Math.sin(toRad(lng2-lng1))*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-
    Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lng2-lng1));
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
</script>

</body>
</html>