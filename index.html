<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>LIFF Live Navigation</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, -apple-system, sans-serif;
}

#map {
  width: 100%;
  height: 100%;
}

/* ===== Buttons ===== */
.map-btn {
  position: absolute;
  left: 14px;
  z-index: 1000;
  padding: 14px 18px;
  font-size: 16px;
  background: #fff;
  border: 2px solid #222;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

#focusUserBtn { top: 14px; }
#focusBBtn    { top: 72px; }
#routeBtn     { top: 130px; }

/* ===== Bottom Sheet ===== */
#bottomPanel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -260px;
  background: #fff;
  border-radius: 18px 18px 0 0;
  padding: 18px 20px 24px;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
  z-index: 1200;
  transition: bottom 0.3s ease;
}

#bottomPanel.show {
  bottom: 0;
}

#bottomPanel h3 {
  margin: 0 0 8px;
  font-size: 18px;
}

#bottomPanel .item {
  font-size: 16px;
  margin-bottom: 6px;
}

@media (min-width: 768px) {
  .map-btn {
    padding: 18px 22px;
    font-size: 18px;
  }
  #bottomPanel {
    max-width: 520px;
    left: auto;
    right: 20px;
    bottom: -300px;
    border-radius: 16px;
  }
  #bottomPanel.show {
    bottom: 20px;
  }
}
</style>
</head>

<body>

<button id="focusUserBtn" class="map-btn">üìç</button>
<button id="focusBBtn" class="map-btn">üìå</button>
<button id="routeBtn" class="map-btn">üß≠ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>

<div id="bottomPanel">
  <h3>üß≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</h3>
  <div class="item" id="distance">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: -</div>
  <div class="item" id="time">‡πÄ‡∏ß‡∏•‡∏≤: -</div>
  <div class="item" id="place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: -</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
/* ===== MAP ===== */
const map = L.map('map').setView([16.7469, 100.1969], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ===== STATE ===== */
let routingControl = null;
let isRouting = false;
let autoFollow = true;
let lastAutoMove = 0;

/* ===== ICON B (RED PIN) ===== */
const bIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  shadowSize: [41, 41]
});

/* ===== ICON A ===== */
function createUserIcon(heading = 0) {
  return L.divIcon({
    className: '',
    html: `
      <div style="
        width: 24px;
        height: 24px;
        background: #1e88ff;
        border: 4px solid white;
        border-radius: 50%;
        position: relative;
      ">
        <div style="
          position: absolute;
          top: -12px;
          left: 50%;
          transform: translateX(-50%) rotate(${heading}deg);
          width: 0;
          height: 0;
          border-left: 5px solid transparent;
          border-right: 5px solid transparent;
          border-bottom: 12px solid #1e88ff;
        "></div>
      </div>
    `,
    iconSize: [28, 28],
    iconAnchor: [14, 14]
  });
}

/* ===== MARKERS ===== */
let bLat = 16.7479, bLng = 100.1947;
const bMarker = L.marker([bLat, bLng], { icon: bIcon }).addTo(map);

let userLat, userLng, userMarker;

/* ===== STOP AUTO FOLLOW WHEN USER DRAGS MAP ===== */
map.on('dragstart zoomstart', () => {
  autoFollow = false;
});

/* ===== GEOLOCATION ===== */
navigator.geolocation.watchPosition(pos => {
  userLat = pos.coords.latitude;
  userLng = pos.coords.longitude;
  const heading = pos.coords.heading || 0;

  if (!userMarker) {
    userMarker = L.marker([userLat, userLng], {
      icon: createUserIcon(heading)
    }).addTo(map);
  } else {
    userMarker.setLatLng([userLat, userLng])
              .setIcon(createUserIcon(heading));
  }

  updateRoute();

  const now = Date.now();
  if (isRouting && autoFollow && now - lastAutoMove > 1200) {
    map.flyTo([userLat, userLng], 18, {
      animate: true,
      duration: 0.8
    });
    lastAutoMove = now;
  }
}, null, { enableHighAccuracy: true });

/* ===== ROUTING ===== */
async function getPlaceName() {
  const res = await fetch(
    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${bLat}&lon=${bLng}`
  );
  const data = await res.json();
  return data.display_name || '-';
}

function startRouting() {
  if (!userLat || !userLng) return;

  if (routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1'
    }),
    waypoints: [
      L.latLng(userLat, userLng),
      L.latLng(bLat, bLng)
    ],
    addWaypoints: false,
    show: false,
    createMarker: () => null,
    lineOptions: {
      styles: [{ color: '#1e88ff', weight: 6 }]
    }
  }).addTo(map);

  routingControl.on('routesfound', async e => {
    const r = e.routes[0];
    distance.innerText =
      `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${(r.summary.totalDistance/1000).toFixed(2)} ‡∏Å‡∏°.`;
    time.innerText =
      `‡πÄ‡∏ß‡∏•‡∏≤: ${(r.summary.totalTime/60).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
    place.innerText =
      `‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${await getPlaceName()}`;
    bottomPanel.classList.add('show');
  });

  isRouting = true;
  autoFollow = true;
  map.flyTo([userLat, userLng], 18, { animate: true, duration: 1 });
}

function stopRouting() {
  if (routingControl) {
    map.removeControl(routingControl);
    routingControl = null;
  }
  bottomPanel.classList.remove('show');
  isRouting = false;
  autoFollow = false;
}

/* ===== UPDATE ROUTE ===== */
function updateRoute() {
  if (routingControl && userLat && userLng) {
    routingControl.setWaypoints([
      L.latLng(userLat, userLng),
      L.latLng(bLat, bLng)
    ]);
  }
}

/* ===== BUTTONS ===== */
routeBtn.onclick = () => {
  if (!isRouting) {
    startRouting();
    routeBtn.innerText = '‚ùå ‡∏õ‡∏¥‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á';
  } else {
    stopRouting();
    routeBtn.innerText = 'üß≠ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á';
  }
};

focusUserBtn.onclick = () => userLat && map.setView([userLat, userLng], 17);
focusBBtn.onclick = () => map.setView([bLat, bLng], 17);
</script>

</body>
</html>