<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>LIFF Live Navigation</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Routing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .map-btn {
      position: absolute;
      left: 12px;
      z-index: 1000;
      padding: 14px 18px;
      font-size: 16px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    }

    #focusUserBtn { top: 12px; }
    #routeBtn { top: 80px; }
    #clearRouteBtn { top: 148px; }

    /* ‡πÅ‡∏ñ‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á */
    #infoBox {
      position: absolute;
      right: 12px;
      top: 12px;
      z-index: 1000;
      background: white;
      padding: 14px 18px;
      border-radius: 12px;
      border: 2px solid #333;
      min-width: 180px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.3);
      font-size: 15px;
    }
  </style>
</head>
<body>

  <button id="focusUserBtn" class="map-btn">üìç ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏´‡∏≤‡∏â‡∏±‡∏ô</button>
  <button id="routeBtn" class="map-btn">üß≠ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
  <button id="clearRouteBtn" class="map-btn">‚ùå ‡∏õ‡∏¥‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>

  <div id="infoBox">
    <div><b>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</b> -</div>
    <div><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> -</div>
  </div>

  <div id="map"></div>

  <!-- JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <script>
    /* ======================
       MAP
    ====================== */
    const map = L.map('map').setView([16.7469, 100.1969], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap'
    }).addTo(map);

    /* ======================
       ICONS
    ====================== */
    const userIcon = L.icon({
      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    const bIcon = L.icon({
      iconUrl: 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32]
    });

    /* ======================
       MARKER B
    ====================== */
    let bLat = 16.7479;
    let bLng = 100.1947;

    const bMarker = L.marker([bLat, bLng], { icon: bIcon })
      .addTo(map)
      .bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á B');

    /* ======================
       MARKER A
    ====================== */
    let userLat = null;
    let userLng = null;
    let userMarker = null;

    navigator.geolocation.watchPosition(pos => {
      userLat = pos.coords.latitude;
      userLng = pos.coords.longitude;

      if (!userMarker) {
        userMarker = L.marker([userLat, userLng], { icon: userIcon })
          .addTo(map)
          .bindPopup('‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì');
      } else {
        userMarker.setLatLng([userLat, userLng]);
      }

      updateRoute(); // A ‡∏Ç‡∏¢‡∏±‡∏ö ‚Üí route ‡∏Ç‡∏¢‡∏±‡∏ö
    }, null, { enableHighAccuracy: true });

    /* ======================
       ROUTING
    ====================== */
    let routingControl = null;

    function startRouting() {
      if (!userLat || !userLng) return;

      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(userLat, userLng),
          L.latLng(bLat, bLng)
        ],
        addWaypoints: false,
        draggableWaypoints: false,
        routeWhileDragging: false,
        show: false,
        createMarker: () => null,
        lineOptions: {
          styles: [{ color: 'blue', weight: 6 }]
        }
      }).addTo(map);

      routingControl.on('routesfound', e => {
        const route = e.routes[0];
        document.getElementById('infoBox').innerHTML = `
          <div><b>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</b> ${(route.summary.totalDistance / 1000).toFixed(2)} ‡∏Å‡∏°.</div>
          <div><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> ${(route.summary.totalTime / 60).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
        `;
      });
    }

    function updateRoute() {
      if (routingControl && userLat && userLng) {
        routingControl.setWaypoints([
          L.latLng(userLat, userLng),
          L.latLng(bLat, bLng)
        ]);
      }
    }

    /* ======================
       SIMULATE B MOVE
    ====================== */
    setInterval(() => {
      bLat += (Math.random() - 0.5) * 0.0004;
      bLng += (Math.random() - 0.5) * 0.0004;
      bMarker.setLatLng([bLat, bLng]);
      updateRoute(); // B ‡∏Ç‡∏¢‡∏±‡∏ö ‚Üí route ‡∏Ç‡∏¢‡∏±‡∏ö
    }, 5000);

    /* ======================
       BUTTONS
    ====================== */
    document.getElementById('routeBtn').onclick = startRouting;

    document.getElementById('clearRouteBtn').onclick = () => {
      if (routingControl) {
        map.removeControl(routingControl);
        routingControl = null;
        document.getElementById('infoBox').innerHTML =
          `<div><b>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á:</b> -</div><div><b>‡πÄ‡∏ß‡∏•‡∏≤:</b> -</div>`;
      }
    };

    document.getElementById('focusUserBtn').onclick = () => {
      if (userLat && userLng) {
        map.setView([userLat, userLng], 16);
      }
    };
  </script>

</body>
</html>