<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>LIFF Live Navigation</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"/>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  font-family: system-ui, -apple-system, sans-serif;
}

#map {
  width: 100%;
  height: 100%;
}

/* ===== Buttons ===== */
.map-btn {
  position: absolute;
  left: 14px;
  z-index: 1000;
  padding: 14px 18px;
  font-size: 16px;
  background: #fff;
  border: 2px solid #222;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}

#focusUserBtn { top: 14px; }
#focusBBtn    { top: 72px; }
#routeBtn     { top: 130px; }

/* ===== Bottom Sheet ===== */
#bottomPanel {
  position: fixed;
  left: 0;
  right: 0;
  bottom: -260px;
  background: #fff;
  border-radius: 18px 18px 0 0;
  padding: 18px 20px 24px;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
  z-index: 1200;
  transition: bottom 0.3s ease;
}

#bottomPanel.show {
  bottom: 0;
}

#bottomPanel h3 {
  margin: 0 0 8px;
  font-size: 18px;
}

#bottomPanel .item {
  font-size: 16px;
  margin-bottom: 6px;
}
</style>
</head>

<body>

<button id="focusUserBtn" class="map-btn">üìç</button>
<button id="focusBBtn" class="map-btn">üìå</button>
<button id="routeBtn" class="map-btn">üß≠ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>

<div id="bottomPanel">
  <h3>üß≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</h3>
  <div class="item" id="distance">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: -</div>
  <div class="item" id="time">‡πÄ‡∏ß‡∏•‡∏≤: -</div>
  <div class="item" id="place">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: -</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
/* ===== MAP ===== */
const map = L.map('map').setView([16.7469, 100.1969], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

/* ===== STATE ===== */
let routingControl = null;
let isRouting = false;
let autoFollow = true;
let lastAutoMove = 0;

/* ===== ICON B ===== */
const bIcon = L.icon({
  iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  shadowSize: [41, 41]
});

/* ===== ICON A ===== */
function createUserIcon(heading = 0) {
  return L.divIcon({
    className: '',
    html: `
      <div style="
        width: 32px;
        height: 32px;
        transform: rotate(${heading}deg);
        transition: transform 0.2s linear;
      ">
        <svg width="32" height="32" viewBox="0 0 100 100">
          <!-- ‡∏ß‡∏á‡∏Å‡∏•‡∏° -->
          <circle cx="50" cy="50" r="20"
            fill="#1e88ff"
            stroke="white"
            stroke-width="6"
          />
          <!-- ‡∏´‡∏±‡∏ß‡∏•‡∏π‡∏Å‡∏®‡∏£ -->
          <polygon points="50,5 42,28 58,28"
            fill="#1e88ff"
          />
        </svg>
      </div>
    `,
    iconSize: [32, 32],
    iconAnchor: [16, 16]
  });
}

/* ===== MARKERS ===== */
let bLat = 16.7479, bLng = 100.1947;
const bMarker = L.marker([bLat, bLng], { icon: bIcon }).addTo(map);

let userLat, userLng, userMarker;

/* ===== SIMULATE B MOVE ===== */
setInterval(() => {
  bLat += (Math.random() - 0.5) * 0.0003;
  bLng += (Math.random() - 0.5) * 0.0003;
  bMarker.setLatLng([bLat, bLng]);
  if (routingControl) updateRoute();
}, 5000);

/* ===== STOP AUTO FOLLOW WHEN USER DRAGS ===== */
map.on('dragstart zoomstart', () => autoFollow = false);

/* ===== GEOLOCATION ===== */
navigator.geolocation.watchPosition(pos => {
  const lat = pos.coords.latitude;
  const lng = pos.coords.longitude;
  const speed = pos.coords.speed || 0;

  let heading = headingSmooth;

  if (lastLat !== null && lastLng !== null && speed > 0.4) {
    const newHeading = calcHeading(lastLat, lastLng, lat, lng);
    heading = smooth(headingSmooth, newHeading);
  }

  headingSmooth = heading;

  if (!userMarker) {
    userMarker = L.marker([lat, lng], {
      icon: createUserIcon(headingSmooth)
    }).addTo(map);
  } else {
    userMarker
      .setLatLng([lat, lng])
      .setIcon(createUserIcon(headingSmooth));
  }

  lastLat = lat;
  lastLng = lng;

  if (isRouting && autoFollow) {
    map.panTo([lat, lng], { animate: true, duration: 0.6 });
  }

}, null, { enableHighAccuracy: true });

/* ===== ROUTING ===== */
async function getPlaceName() {
  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${bLat}&lon=${bLng}`
    );
    const data = await res.json();
    return data.display_name || '-';
  } catch {
    return '-';
  }
}

function startRouting() {
  if (!userLat || !userLng) return;

  if (routingControl) map.removeControl(routingControl);

  routingControl = L.Routing.control({
    router: L.Routing.osrmv1({
      serviceUrl: 'https://router.project-osrm.org/route/v1',
      timeout: 10000
    }),
    waypoints: [
      L.latLng(userLat, userLng),
      L.latLng(bLat, bLng)
    ],
    addWaypoints: false,
    draggableWaypoints: false,
    routeWhileDragging: false,
    fitSelectedRoutes: true,
    show: false,
    createMarker: () => null,
    lineOptions: {
      styles: [{ color: '#1e88ff', weight: 6, opacity: 0.9 }]
    }
  }).addTo(map);

  routingControl.on('routesfound', e => {
    const r = e.routes[0];

    distance.innerText =
      `‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${(r.summary.totalDistance/1000).toFixed(2)} ‡∏Å‡∏°.`;
    time.innerText =
      `‡πÄ‡∏ß‡∏•‡∏≤: ${(r.summary.totalTime/60).toFixed(1)} ‡∏ô‡∏≤‡∏ó‡∏µ`;

    place.innerText = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    bottomPanel.classList.add('show');

    getPlaceName().then(name => {
      place.innerText = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: ${name}`;
    });
  });

  routingControl.on('routingerror', () => {
    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏î‡πâ');
  });

  isRouting = true;
  autoFollow = true;
  map.flyTo([userLat, userLng], 18, { animate: true, duration: 1 });
}

function stopRouting() {
  if (routingControl) map.removeControl(routingControl);
  routingControl = null;
  bottomPanel.classList.remove('show');
  isRouting = false;
  autoFollow = false;
}

/* ===== UPDATE ROUTE ===== */
function updateRoute() {
  if (routingControl && userLat && userLng) {
    routingControl.setWaypoints([
      L.latLng(userLat, userLng),
      L.latLng(bLat, bLng)
    ]);
  }
}

/* ===== BUTTONS ===== */
routeBtn.onclick = () => {
  if (!isRouting) {
    startRouting();
    routeBtn.innerText = '‚ùå ‡∏õ‡∏¥‡∏î‡∏ô‡∏≥‡∏ó‡∏≤‡∏á';
  } else {
    stopRouting();
    routeBtn.innerText = 'üß≠ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡∏ó‡∏≤‡∏á';
  }
};

focusUserBtn.onclick = () => userLat && map.setView([userLat, userLng], 17);
focusBBtn.onclick = () => map.setView([bLat, bLng], 17);

function calcHeading(lat1, lng1, lat2, lng2) {
  const toRad = d => d * Math.PI / 180;
  const y = Math.sin(toRad(lng2 - lng1)) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.cos(toRad(lng2 - lng1));
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

let lastLat = null;
let lastLng = null;
let headingSmooth = 0;

function smooth(prev, next, factor = 0.2) {
  let diff = ((next - prev + 540) % 360) - 180;
  return prev + diff * factor;
}
</script>

</body>
</html>
